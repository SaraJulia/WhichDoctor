<html>

   
  <div id="allresults" class="container">
    <div div id="map-panel" class="col-md-5" style="height: 400px;"></div> 
    <div id="results-table" class="col-md-7 pager tablesorter-pager">
      <table class="table table-striped tablesorter" id='drtable'>
           <thead>
              <tr>
                 <th><span class="glyphicon glyphicon-sort" aria-hidden="true"></span>   Doctor</th>
                 <th><span class="glyphicon glyphicon-sort" aria-hidden="true"></span>   Specialty</th>
                 <th><span class="glyphicon glyphicon-sort" aria-hidden="true"></span>   Cost</th>
              </tr>
           </thead>
           <tbody>

              {% set counter = 0 -%}

              {% for doctor in doctor_list %}

                <tr class="drsrow" id="{{counter}}">
                    <td> <a href="/provider?id={{ doctor.npi }}"> {{ doctor.givenname }} {{ doctor.surname }}{% if doctor.credential %}, {{ doctor.credential }} {% endif %}</a> </td>
                    <td> {{ doctor.specialty }} </td>
                    <td class="dollaz {{doctor.numdollars}}"> {{ doctor.dollars }} </td>
                </tr>

                {% set counter = counter + 1 -%}
              
              {% endfor %}
              
            </tbody>
        </table>
<!--         <nav>
            <ul class="pager">
              <li><a href="#" class=".first">First</a></li>
              <li><a href="#" class=".prev">Previous</a></li>
              <li><a href="#" class=".next">Next</a></li>
              <li><a href="#" class=".last">Last</a></li>
            </ul>
          </ul>
        </nav> -->
    </div>
  </div>
    <script>

      //var events = new MicroEvent();

      function drawMap(){

        //alert("drawMap is called");
        console.log("drawMap got called!");

        L.mapbox.accessToken = 'pk.eyJ1Ijoic2FyYWp1bGlhIiwiYSI6Imw5YlJaYmsifQ.6MhrXBPE3xp8hu3Nqbk4iQ';

        var map = L.mapbox.map('map-panel', 'sarajulia.k9kblj6l',
            {scrollWheelZoom: false});

        return map;
      }

      function make_geojson(){
        console.log("make_geojson got called!");

        var i = 0;

        geojson = [];

        {% for doctor in doctor_list: %}

          {% if doctor.dollars == "$" or doctor.dollars == "$$" %}

            var color = "#04B431";
            {% elif doctor.dollars == '$$$' %}
            var color = "#FFFF00";
            {% elif doctor.dollars == '$$$$' or doctor.dollars == '$$$$$' %}
            var color = "#DF0101";

          {% endif %}

          geojson.push({
            type: 'Feature',
            geometry: {
              type: 'Point',
              // coordinates here are in longitude, latitude order
              coordinates: [
                {{ doctor.lng }}, {{ doctor.lat }} 
              ]
            },
            properties: {
              title: "{{ doctor.givenname }} {{ doctor.surname }}{% if doctor.credential %}, {{ doctor.credential }} {% endif %}",
              description: "{{ doctor.addy1 }} {% if doctor.addy2 %} {{ doctor.addy2 }} {% endif %} {{ doctor.city }}, {{ doctor.state }} {{ doctor.short_zip }}",
              // https://www.mapbox.com/foundations/an-open-platform/#simplestyle
              'marker-size': 'small',
              'marker-color': color,
              'marker-line-color': '#2E2E2E',
              'marker-allow-overlap': false,
              }
            });

            //console.log("Added {{doctor.surname}}")

        {% endfor %}

        //console.log(geojson);
        return geojson;

      }


      $.tablesorter.addParser({ 
        // set a unique id 
        id: 'numdollars', 
        is: function(s) { 
          // return false so this parser is not auto detected 
          return false; 
        }, 
        format: function(s) { 
          // format data for normalization 
          return s.replace('$$$$$',5).replace('$$$$',4).replace('$$$',3).replace('$$',2).replace('$',1); 
          }, 
          // set type, either numeric or text 
          type: 'numeric' 
        }); 

      $(document).ready(function() { 
          // alert("document is ready");

        var map = drawMap();

        geojson = make_geojson();

        var pins_layer = L.mapbox.featureLayer(geojson).addTo(map);

        map.fitBounds(pins_layer.getBounds());

        $("#sticker").sticky({topSpacing:10});

        //THIS IS FOR CREATING A PAGINATED TABLE
        // var pagerOptions = {
        //   container: $(".pager"),

        //   // apply disabled classname to the pager arrows when the rows at either extreme is visible - default is true
        //   updateArrows: true,

        //   // starting page of the pager (zero based index)
        //   page: 0,

        //   // Number of visible rows - default is 10
        //   size: 20,

        //   // css class names of pager arrows
        //   cssNext: '.next', // next page arrow
        //   cssPrev: '.prev', // previous page arrow
        //   cssFirst: '.first', // go to first page arrow
        //   cssLast: '.last', // go to last page arrow
        //   cssGoto: '.gotoPage', // select dropdown to allow choosing a page
        // };

        $("#drtable").tablesorter({ headers: {2: {sorter:'numdollars'} } });

        //.tablesorterPager(pagerOptions);
     

        $(".drsrow")
          .on('mouseover', function(){
            var idx = parseInt($(this).attr('id'));
            geojson[idx].properties["marker-size"] = "medium";
            pins_layer.setGeoJSON(geojson);
            pins_layer.addTo(map);
          //events.trigger('listing-mouse-in', idx);
          })
          .on('mouseout', function(){
            var idx = parseInt($(this).attr('id'));
            geojson[idx].properties["marker-size"] = "small";
            pins_layer.setGeoJSON(geojson);
            pins_layer.addTo(map);
            //events.trigger('listing-mouse-out', idx);
          });
      }); 

          // this section was for clustering the pins
          // var markers = new L.MarkerClusterGroup();

          // {% for doctor in doctor_list: %}
          //     var title = "{{ doctor.givenname }} {{ doctor.surname }}{% if doctor.credential %}, {{ doctor.credential }} {% endif %}";
          //     var address = "{{ doctor.addy1 }} {% if doctor.addy2 %} {{ doctor.addy2 }} {% endif %} {{ doctor.city }}, {{ doctor.state }} {{ doctor.short_zip }}";

          //     {% if doctor.dollars == "$" or doctor.dollars == "$$" %}
          //     var color = "#04B431";
          //     {% elif doctor.dollars == '$$$' %}
          //     var color = "#FFFF00";
          //     {% elif doctor.dollars == '$$$$' or doctor.dollars == '$$$$$' %}
          //     var color = "#DF0101";
          //     {% endif %}

          //     var marker = L.marker(new L.LatLng({{ doctor.lat }}, {{ doctor.lng }}), {
          //         icon: L.mapbox.marker.icon({'marker-size': 'small',
          //                                     'marker-color': color,
          //                                     'marker-allow-overlap': false,}),
          //         title: title,
          //         description: address
          //     });
          //     marker.bindPopup(title);
          //     markers.addLayer(marker);
          // {% endfor %}

          // map.addLayer(markers);

      

    </script>

</html>