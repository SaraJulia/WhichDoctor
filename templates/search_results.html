<html>

   
  <div id="allresults" class="container">
    <div id="map-panel" class="col-md-5" style="height: 400px;"><!-- style="height: 100px;" --></div> 
    <div id="results-table" class="col-md-7">
      <table class="table table-striped tablesorter" id='drtable'>
           <thead>
              <tr>
                 <th><span class="glyphicon glyphicon-sort" aria-hidden="true"></span>   Doctor</th>
                 <th><span class="glyphicon glyphicon-sort" aria-hidden="true"></span>   Specialty</th>
                 <th><span class="glyphicon glyphicon-sort" aria-hidden="true"></span>   Cost</th>
              </tr>
           </thead>
           <tbody>

              {% for doctor in doctor_list %}

                <tr>
                    <td> <a href="/provider?id={{ doctor.npi }}"> {{ doctor.givenname }} {{ doctor.surname }}{% if doctor.credential %}, {{ doctor.credential }} {% endif %}</a> </td>
                    <td> {{ doctor.specialty }} </td>
                    <td class="dollaz {{doctor.numdollars}}"> {{ doctor.dollars }} </td>
                </tr>
              
              {% endfor %}
              
             </tbody>
      </table>
    </div>
  </div>
    <script>

      function drawMap(){

        //alert("drawMap is called");
        console.log("drawMap got called!");

        L.mapbox.accessToken = '';

        var map = L.mapbox.map('map-panel', 'sarajulia.k9kblj6l',
            {scrollWheelZoom: false});

        map.setView([37.769, -122.459], 13);

        return map;
      }

      function addPin(map, lat, lng, name, address, color){
        console.log("addPin is called for: ", name, address, lng, lat, color);

        L.mapbox.featureLayer({
          // this feature is in the GeoJSON format: see geojson.org
          // for the full specification
          type: 'Feature',
          geometry: {
            type: 'Point',
            // coordinates here are in longitude, latitude order because
            // x, y is the standard for GeoJSON and many formats
            coordinates: [
              lng,
              lat 
            ]
          },
          properties: {
            title: name,
            description: address,
            // one can customize markers by adding simplestyle properties
            // https://www.mapbox.com/foundations/an-open-platform/#simplestyle
            'marker-size': 'small',
            'marker-color': color,
            'marker-allow-overlap': false,
          }
        }).addTo(map);

      }

      $.tablesorter.addParser({ 
        // set a unique id 
        id: 'numdollars', 
        is: function(s) { 
          // return false so this parser is not auto detected 
          return false; 
        }, 
        format: function(s) { 
          // format your data for normalization 
          return s.replace('$$$$$',5).replace('$$$$',4).replace('$$$',3).replace('$$',2).replace('$',1); 
          }, 
          // set type, either numeric or text 
          type: 'numeric' 
        }); 



      $(document).ready(function() 
        { 
          // alert("document is ready");

          var map = drawMap();

          {% for doctor in doctor_list: %}

              var name = "{{ doctor.givenname }} {{ doctor.surname }}{% if doctor.credential %}, {{ doctor.credential }} {% endif %}";
              var address = "{{ doctor.addy1 }} {% if doctor.addy2 %} {{ doctor.addy2 }} {% endif %} {{ doctor.city }}, {{ doctor.state }} {{ doctor.short_zip }}";
              var lat = {{ doctor.lat }};
              var lng = {{ doctor.lng }};
              {% if doctor.dollars == "$" or doctor.dollars == "$$" %}
              var color = "#04B431";
              {% elif doctor.dollars == '$$$' %}
              var color = "#FFFF00";
              {% elif doctor.dollars == '$$$$' or doctor.dollars == '$$$$$' %}
              var color = "#DF0101";
              {% endif %}

              addPin(map, lat, lng, name, address, color);

          {% endfor %}

          $("#drtable").tablesorter({

            headers: { 
              2: { 
               sorter:'numdollars' 
              } 
            } 

            }); 
          } 
        ); 

          // this section was for clustering the pins
          // var markers = new L.MarkerClusterGroup();

          // {% for doctor in doctor_list: %}
          //     var title = "{{ doctor.givenname }} {{ doctor.surname }}{% if doctor.credential %}, {{ doctor.credential }} {% endif %}";
          //     var address = "{{ doctor.addy1 }} {% if doctor.addy2 %} {{ doctor.addy2 }} {% endif %} {{ doctor.city }}, {{ doctor.state }} {{ doctor.short_zip }}";

          //     {% if doctor.dollars == "$" or doctor.dollars == "$$" %}
          //     var color = "#04B431";
          //     {% elif doctor.dollars == '$$$' %}
          //     var color = "#FFFF00";
          //     {% elif doctor.dollars == '$$$$' or doctor.dollars == '$$$$$' %}
          //     var color = "#DF0101";
          //     {% endif %}

          //     var marker = L.marker(new L.LatLng({{ doctor.lat }}, {{ doctor.lng }}), {
          //         icon: L.mapbox.marker.icon({'marker-size': 'small',
          //                                     'marker-color': color,
          //                                     'marker-allow-overlap': false,}),
          //         title: title,
          //         description: address
          //     });
          //     marker.bindPopup(title);
          //     markers.addLayer(marker);
          // {% endfor %}

          // map.addLayer(markers);

      

    </script>

</html>